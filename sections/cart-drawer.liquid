{%- if request.page_type != 'cart' and settings.cart_type == 'drawer' -%}
  <script src="{{ 'cart.js' | asset_url }}" defer></script>
  {%- if linklists.gift-wrapping.links != blank and linklists.gift-wrapping.links.first.type == 'product_link' -%}
    <script src="{{ 'gift-wrapping.js' | asset_url }}" defer="defer"></script>
  {%- endif -%}

  <cart-drawer id="CartDrawer" class="fixed bottom-0 left-0 z-30 w-full h-full pointer-events-none cart-drawer drawer drawer--end"
    role="dialog"
    aria-modal="true"
    aria-label="{{ 'general.cart.title' | t | escape }}"
    data-section-id="{{ section.id }}"
    shopify-design-mode
    hidden
  > 
    <overlay-element class="fixed bottom-0 left-0 invisible w-full h-screen opacity-0 pointer-events-none overlay fixed-modal" aria-controls="CartDrawer" aria-expanded="false"></overlay-element>
    
    <div class="absolute top-0 z-10 flex flex-col w-full h-full overflow-hidden drawer__inner {%if section.settings.cart_recommendations_enabled %}lg:!jc-rounded-none{% endif %} jc-overflow-visible">
      <gesture-element class="relative flex items-center justify-between invisible opacity-0 drawer__header">
        <ul class="flex gap-10 drawer__tabs" is="tab-list">
          <li>
            <button class="relative drawer__tab" type="button" aria-controls="MiniCart-{{ section.id }}" aria-expanded="true">
              <span class="text-2xl font-bold leading-none tracking-tight drawer__title heading lg:text-3xl">{{ 'general.cart.title' | t }}</span>
              <cart-count class="absolute text-xs font-medium leading-none count lg:text-sm" aria-label="{{ 'general.cart.cart_count' | t: count: cart.item_count | escape }}"{% if cart == empty %} hidden{% endif %}>{{ cart.item_count }}</cart-count>
            </button>
          </li>
          {%- if section.settings.recent_products_enabled -%}
            <li>
              <button class="drawer__tab" type="button" aria-controls="RecentlyViewed-{{ section.id }}" aria-expanded="false">
                <span class="text-2xl font-bold leading-none tracking-tight drawer__title heading lg:text-3xl">{{ section.settings.recent_products_heading | escape }}</span>
              </button>
            </li>
          {%- endif -%}
        </ul>
        <button class="items-center justify-center hidden button button--secondary button--close drawer__close sm:flex" type="button" is="hover-button" aria-controls="CartDrawer" aria-expanded="false" aria-label="{{ 'general.accessibility.close' | t | escape }}">
          <span class="btn-fill" data-fill></span>
          <span class="btn-text">
            {%- render 'icon', icon: 'close', size: 'sm' -%}
          </span>
        </button>
      </gesture-element>

      <div class="flex flex-col invisible h-full opacity-0 drawer__content grow shrink">
        <details id="MiniCart-{{ section.id }}" class="flex flex-col overflow-hidden opacity-0 drawer__panel" open>
          <summary class="sr-only" tabindex="-1">{{ 'general.cart.title' | t }}</summary>
          <div class="cust__drawer__panel-main flex flex-col h-full">
            {%- if cart == empty -%}
              <div class="relative flex items-start justify-center text-center drawer__scrollable grow shrink">
                <div class="grid gap-5 drawer__empty lg:gap-8">
                  <h2 class="font-bold leading-none tracking-tight drawer__empty-text">{{ 'cart.general.empty' | t }}</h2>
                  <div class="text-sm leading-tight drawer__empty-message lg:text-base rte">
                    {{- section.settings.empty_cart_message -}}
                  </div>
                  <ul class="grid gap-3 drawer__empty-collections">
                    {%- if section.settings.empty_cart_collections == blank -%}
                      <li>
                        <a class="flex items-center justify-between" href="{{ routes.all_products_collection_url }}">
                          <span class="flex items-center">{{ 'cart.general.continue_shopping' | t }}</span>
                          {%- render 'icon', icon: 'arrow-right', size: 'sm', class: 'transform' -%}
                        </a>
                      </li>
                    {%- else -%}
                      {%- for item in section.settings.empty_cart_collections -%}
                        <li>
                          <a class="flex items-center justify-between" href="{{ item.url }}">
                            <span class="flex items-center gap-3">
                              {%- liquid
                                if item.metafields.theme.icon.value != blank
                                  echo item.metafields.theme.icon.value | image_url: width: item.metafields.theme.icon.value.width | image_tag: loading: 'lazy', widths: '80,96,160,192', is: 'lazy-image'
                                endif
    
                                echo item.title
                              -%}
                            </span>
                            {%- render 'icon', icon: 'arrow-right', size: 'sm', class: 'transform' -%}
                          </a>
                        </li>
                      {%- endfor -%}
                    {%- endif -%}
                  </ul>
                </div>
              </div>
            {%- endif -%}
            <div class="drawer__scrollable jc-flex jc-flex-col jc-flex-grow {% if cart == empty %} hidden {% endif %} !jc-pb-0 !jc-px-0">
              {%- liquid
                if section.settings.show_free_shipping_bar 
                  assign steps_completed = 0
      
                  assign foxsell_bundles_present = false
                  for item in cart.items
                    if item.properties["__foxsell:dynamic_bundle_category"] != blank or item.properties["__foxsell:dynamic_add_on_bundle_id"] != blank
                      assign foxsell_bundles_present = true
                    endif
                  endfor
                
                  if cart.item_count > 2 or foxsell_bundles_present
                    assign steps_completed = 3
                  elsif cart.item_count > 1
                    assign steps_completed = 2
                  elsif cart.item_count > 0
                    assign steps_completed = 1
                  endif     
      
                endif
              -%}

              {%- if steps_completed > 0 -%}  
                {% assign image_handle = "step_" | append: steps_completed | append: "_icon" %}
                {% assign image = section.settings[image_handle] %}
        
                <div class="[&_p]:jc-m-0 [&_p_em]:!jc-not-italic [&_p_em]:!jc-text-vividTangelo jc-text-sm jc-leading-4 jc-font-bold jc-transition-all jc-py-0 jc-p-6 lg:jc-px-12">
                  <div class="jc-flex jc-items-center jc-gap-2 jc-mb-2 jc-transition-all">
                    {%- if image != blank -%}   
                      {% render "g-render-image"
                        class: "jc-w-auto jc-h-6.5",
                        img_src: image.src,
                        img: image,
                        size: "200 400",
                        alt: image.alt,
                        width: image.width,
                        height: image.height
                        loading: "lazy"
                        id: image.id
                      %}
                    {%- endif -%}
          
                    {%- if steps_completed > 2 and section.settings.step_3_text != blank -%}
                      {{ section.settings.step_3_text }}
                    {%- elsif steps_completed > 1 and section.settings.step_2_text != blank -%}
                      {{ section.settings.step_2_text }}
                    {%- elsif steps_completed > 0  and section.settings.step_1_text != blank -%}
                      {{ section.settings.step_1_text }}
                    {%- endif -%}
                  </div>
                  {% render 'free-shipping-bar', step_based: true, steps_completed: steps_completed %}
                </div>
              {%- endif -%}


              {%- liquid
                if linklists.gift-wrapping.links != blank and linklists.gift-wrapping.links.first.type == 'product_link'
                  assign gift_wrapping = linklists.gift-wrapping.links.first
              
                  assign gift_wrap_id = gift_wrapping.object.variants.first.id
                  assign gift_wraps_in_cart = 0
                  for item in cart.items
                    if item.id == gift_wrap_id
                      assign gift_wraps_in_cart = item.quantity
                      break
                    endif
                  endfor
                  assign items_in_cart = cart.item_count | minus: gift_wraps_in_cart
                endif
              -%}
              <cart-items class="block grow jc-p-6 lg:jc-px-12">
                <ul class="grid horizontal-products" role="list">
                  {%- for item in cart.items -%}
                    {%- liquid
                      assign is_gift_wrap_item = false
  
                      if gift_wrap_id != nil and item.id == gift_wrap_id
                        assign is_gift_wrap_item = true
                      endif

                      if item.variant.inventory_management != blank and item.variant.inventory_policy == 'deny'
                        assign item_max_quantity = item.variant.inventory_quantity
                      endif
                    -%}

                    {%- capture cart_item -%}
                      <li id="CartDrawer-Item-{{ item.index | plus: 1 }}" class="flex items-center jc-gap-3 lg:jc-gap-4 horizontal-product jc-items-start" data-variant-id="{{ item.variant_id }}" data-handle="{{ item.product.handle }}" data-quantity="{{ item.quantity }}" data-price="{{ item.original_price }}">
                        {%- if item.image -%}
                          <a class="relative flex-auto overflow-hidden horizontal-product__media media media--square" href="{{ item.url }}" tabindex="-1">
                            {{- item.image | image_url: width: item.image.width | image_tag: loading: 'lazy', widths: '180,360,540', is: 'lazy-image' -}}
                            {%- if item.final_price == 0 -%}
                              {% render 'icon', icon: "gift", class: "jc-absolute jc-top-1 jc-left-1" %}
                            {%- endif -%}
                          </a>
                        {%- endif -%}
                        <div class="flex flex-col horizontal-product__details jc-justify-between jc-h-full">
                          <div class="grid gap-1">
                            <div class="block">
                              {%- if section.settings.show_vendor -%}
                                <p class="text-xs text-opacity">{{ item.product.vendor }}</p>
                              {%- endif -%}
                              <a href="{{ item.url }}" class="jc-text-sm jc-leading-4 jc-font-bold jc-uppercase horizontal-product__title reversed-link">{{ item.product.title | escape }}</a>
                              {% comment %}START DIALECT - Add inspiration in the product line in the cart{% endcomment %}
                              {% render 'cust__cart__product-item__inspired-by' product: item.product %}
                              {% comment %}END DIALECT - Add inspiration in the product line in the cart{% endcomment %}
                            </div>

                            {%- if item.product.has_only_default_variant == false or item.properties.size != 0 or item.selling_plan_allocation != null -%}
                              <dl class="grid gap-1d5 jc-pt-2">
                                {%- if item.product.has_only_default_variant == false -%}
                                  {%- for option in item.options_with_values -%}
                                    <div class="flex gap-1 text-xs leading-tight text-opacity">
                                      <dt class="sr-only">{{ option.name }}:</dt>
                                      <dd>{{ option.value }}</dd>
                                    </div>
                                  {%- endfor -%}
                                {%- endif -%}
        
                                {%- for property in item.properties -%}
                                  {%- assign property_first_char = property.first | slice: 0 -%}
                                  {%- if property.last != blank and property_first_char != '_' -%}
                                    <div class="flex gap-1 text-xs leading-tight text-opacity">
                                      <dt>{{ property.first }}:&nbsp;</dt>
                                      <dd>
                                        {%- if property.last contains '/uploads/' -%}
                                          <a href="{{ property.last }}" class="link" target="_blank" aria-describedby="a11y-new-window-message">
                                            {{- property.last | split: '/' | last -}}
                                          </a>
                                        {%- else -%}
                                          {{- property.last -}}
                                        {%- endif -%}
                                      </dd>
                                    </div>
                                  {%- endif -%}
                                {%- endfor -%}
                              </dl>
        
                              {%- if item.selling_plan_allocation != null -%}
                                <p class="text-xs text-opacity">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                              {%- endif -%}
                            {%- endif -%}
                          </div>
                          
                          <div class="grid gap-1 !jc-mt-4">
                            <div class="price{% if item.original_price != item.final_price %} price--on-sale{% endif %} text-sm flex flex-wrap jc-items-start">
                              {%- if item.properties["__foxsell:dynamic_bundle_category"] == blank and item.properties["__foxsell:dynamic_add_on_bundle_id"] == blank -%}
                                <cart-quantity class="relative cart-quantity jc-w-fit jc-flex jc-items-center jc-justify-center jc-border jc-border-solid jc-border-lightGray jc-rounded-full jc-h-8">
                                  <button type="button" name="minus" class="cursor-pointer jc-py-auto jc-px-2.5" aria-label="{{ 'products.quantity.decrease' | t: product: item.product.title | escape }}">
                                    {%- render 'icon', icon: 'minus-2', size: 'sm', class: 'stroke-1 jc-w-3 jc-h-3' -%}
                                  </button>
                                  <label class="sr-only" for="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}">
                                    {{- 'products.quantity.label' | t -}}
                                  </label>
                                  <input class="w-full h-full text-center quantity__input input jc-bg-transparent jc-text-xs jc-leading-4 !jc-px-0"
                                    type="text"
                                    name="updates[]"
                                    value="{{ item.quantity }}"
                                    min="0"
                                    {% if item_max_quantity %}max="{{ item_max_quantity }}"{% endif %}
                                    aria-label="{{ 'products.quantity.input_label' | t: product: item.product.title | escape }}"
                                    id="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}"
                                    data-index="{{ item.index | plus: 1 }}"
                                    size="2"
                                    inputmode="numeric"
                                    autocomplete="off"
                                    is="quantity-input"
                                  />
                                  <button type="button" name="plus" class="cursor-pointer jc-py-auto jc-px-2.5" aria-label="{{ 'products.quantity.increase' | t: product: item.product.title | escape }}">
                                    {%- render 'icon', icon: 'plus', size: 'sm', class: 'stroke-1 jc-w-3 jc-h-3' -%}
                                  </button>
                                </cart-quantity>
                              {% else %}
                                <div class="relative text-xs text-right jc-py-auto">
                                  <a href="{{ settings.bundle_addon_page }}?bundle-id={{ item.properties["__foxsell:dynamic_add_on_bundle_id"] }}&view=foxsell-add-on"
                                    class="link jc-text-chineseBlack jc-text-xs jc-leading-4"
                                    data-no-instant data-bundle-id-to-remove="{{ item.url_to_remove }}">
                                    {{ 'cart.general.edit_bundle' | t }}
                                  </a>
                                </div>
                              {%- endif -%}
                              <div class="relative text-xs text-right jc-py-auto jc-ml-4">
                                <div id="Loader-{{ section.id }}-{{ item.index | plus: 1 }}" class="absolute right-0 loader" hidden>
                                  {%- render 'icon', icon: 'rotator', size: 'xs', class: 'animate-rotator' -%}
                                </div>
                              
                                <a class="link jc-text-chineseBlack jc-text-xs jc-leading-4" href="{{ item.url_to_remove }}"{% unless is_gift_wrap_item %} is="cart-remove-button"{% else %} is="remove-gift-wrap"{% endunless %} data-index="{{ item.index | plus: 1 }}" data-no-instant>{{ 'cart.general.remove' | t }}</a>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="text-sm horizontal-product__quantity shrink-0 sm:block">
                          <div class="grid jc-gap-y-2 jc-text-sm jc-leading-4 jc-font-bold jc-text-end">
                            {%- unless is_gift_wrap_item -%}
                              {%- liquid
                                assign money_price = item.original_price | times: item.quantity | money
                                if settings.currency_code_enabled
                                  assign money_price = item.original_price | times: item.quantity | money_with_currency
                                endif
                              -%}

                              {%- if item.properties["__foxsell:dynamic_bundle_category"] == blank and item.properties["__foxsell:dynamic_add_on_bundle_id"] == blank -%}
                                {%- if item.original_price > item.final_price or item.compare_at_price > item.final_price or item.final_price == 0 -%}
                                  {%- if item.final_price > 0 -%}   
                                    <span class="sr-only">{{ 'products.general.sale_price' | t }}</span>
                                    <span class="price__regular whitespace-nowrap">
                                      {%- liquid
                                        if settings.currency_code_enabled
                                          echo item.final_price | times: item.quantity | money_with_currency
                                        else
                                          echo item.final_price | times: item.quantity | money
                                        endif
                                      -%}
                                    </span>
                                    <span class="sr-only">{{ 'products.general.regular_price' | t }}</span>
                                    <span class="relative inline-flex items-center jc-line-through">{{ money_price }}</span>
                                  {%- else -%}
                                    <span class="jc-uppercase jc-text-vividTangelo jc-font-bold">
                                      {{- 'cart.general.free' | t -}}    
                                    </span>
                                    <span class="jc-line-through jc-font-normal jc-text-xs jc-leading-3 jc-text-chineseBlack">
                                      {%- liquid
                                        if settings.currency_code_enabled
                                          echo item.original_price | times: item.quantity | money_with_currency
                                        else
                                          echo item.original_price | times: item.quantity | money
                                        endif
                                      -%}
                                    </span>
                                  {%- endif -%}
                                {%- else -%}
                                  {{- money_price -}}
                                {%- endif -%}
                              {%- else -%}
                                {% liquid
                                  # calculate bundle savings
                                  assign bundles_savings = 0
                                  assign bundle_raw_price = item.properties["_totalRawPrice"]
                                  
                                  if bundle_raw_price > 0
                                    assign cents_price = bundle_raw_price | times: 100
                                    assign amount_saved = cents_price | minus: item.original_price
                                    assign bundles_savings = bundles_savings | plus: amount_saved
                                    assign current_discount_title = "cart.general.bundle_savings_discount_name" | t
                                  endif
                                %}
                                <span class="price__regular whitespace-nowrap">
                                  {%- liquid
                                    if settings.currency_code_enabled
                                      echo item.original_price | money_with_currency
                                    else
                                      echo item.original_price | money
                                    endif
                                  -%}
                                </span>
                                <span class="relative inline-flex items-center jc-justify-end jc-line-through jc-font-normal jc-text-xs jc-leading-3 jc-text-chineseBlack">
                                  {%- liquid
                                    if settings.currency_code_enabled
                                      echo bundle_raw_price | times: 100 | money_with_currency
                                    else
                                      echo bundle_raw_price | times: 100 | money
                                    endif
                                  -%}
                                </span>
                              {%- endif -%}

                              {%- if item.variant.available and item.unit_price_measurement -%}
                                <span class="sr-only">{{ 'products.general.unit_price' | t }}</span>
                                <span class="flex items-center unit-price">
                                  {%- liquid
                                    capture unit_price_base_unit
                                      if item.variant.unit_price_measurement
                                        if item.variant.unit_price_measurement.reference_value != 1
                                          echo item.variant.unit_price_measurement.reference_value
                                        endif
                                        echo item.variant.unit_price_measurement.reference_unit
                                      endif
                                    endcapture
                                  -%}
                                  ({{ item.variant.unit_price | money }}
                                  <span aria-hidden="true">/</span>
                                  <span class="sr-only">&nbsp;{{ 'general.accessibility.unit_price_separator' | t }}&nbsp;</span>
                                  {{ unit_price_base_unit }})
                                  </span>
                              {%- endif -%}
                            {%- else -%}
                              <gift-quantity
                                class="relative flex items-center cart-quantity" 
                                cart-items-size="{{ cart.items.size }}"
                                gift-wraps-in-cart="{{ gift_wraps_in_cart }}"
                                items-in-cart="{{ items_in_cart }}"
                              >
                                <label class="sr-only" for="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}">
                                  {{- 'products.quantity.label' | t -}}
                                </label>
                                <input class="w-full h-full text-center quantity__input input"
                                  type="number"
                                  name="updates[]"
                                  value="{{ item.quantity }}"
                                  min="0"
                                  {% if item_max_quantity %}max="{{ item_max_quantity }}"{% endif %}
                                  aria-label="{{ 'products.quantity.input_label' | t: product: item.product.title | escape }}"
                                  id="Quantity-{{ section.id }}-{{ item.index | plus: 1 }}"
                                  data-index="{{ item.index | plus: 1 }}"
                                  disabled
                                />
                                <div class="absolute right-0 flex-col items-center justify-center hidden h-full sr-only quantity__buttons lg:flex">
                                  <button type="button" name="plus" class="flex items-end justify-center w-full cursor-pointer quantity__button" aria-label="{{ 'products.quantity.increase' | t: product: item.product.title | escape }}" disabled>
                                    {%- render 'icon', icon: 'increase', size: 'sm', class: 'stroke-1' -%}
                                  </button>
                                  <button type="button" name="minus" class="flex items-start justify-center w-full cursor-pointer quantity__button" aria-label="{{ 'products.quantity.decrease' | t: product: item.product.title | escape }}" disabled>
                                    {%- render 'icon', icon: 'decrease', size: 'sm', class: 'stroke-1' -%}
                                  </button>
                                </div>
                              </gift-quantity>
                            {%- endunless -%}
                          </div>
                        </div>
                      </li>
                    {%- endcapture -%}

                    {%- liquid
                      unless is_gift_wrap_item
                        echo cart_item
                      else
                        assign cart_gift_wrap_item = cart_item
                      endunless
                    -%}
                  {%- endfor -%}

                  {%- liquid
                    if cart_gift_wrap_item
                      echo cart_gift_wrap_item
                    endif
                  -%}
                </ul>
              </cart-items>

              {%- render 'gift-wrapping',
                section_id: section.id,
                gift_wrapping: gift_wrapping,
                gift_wrap_id: gift_wrap_id,
                gift_wraps_in_cart: gift_wraps_in_cart,
                items_in_cart: items_in_cart,
              -%}

              {%- if section.settings.cart_recommendations_enabled -%}
                {%- liquid
                  assign first_product_id = cart.items.first.product_id
                  if cart_gift_wrap_item
                    if first_product_id == gift_wrapping.object.id
                      if cart.items.size > 1
                        assign first_product_id = cart.items[1].product_id
                      endif
                    endif
                  endif
                -%}
                {%- if cart.items.size > 0 -%}
                  {%- render 'product-complementary',
                    section_id: section.id,
                    product_id: first_product_id,
                    limit: section.settings.cart_recommendations_limit,
                    heading: section.settings.cart_recommendations_heading,
                    intent: "related"
                  -%}
                {%- endif -%}
              {%- endif -%}
            </div>
            <div class="drawer__footer grid w-full{% if cart == empty %} hidden{% endif %}">
              {%- if section.settings.show_cart_note or section.settings.show_shipping_calculator -%}
                <div class="flex drawer__footer-top">
                  {%- if section.settings.show_cart_note -%}
                    <button type="button" class="flex items-center justify-center gap-2d5 grow" aria-controls="CartNote-{{ section.id }}" aria-expanded="false">
                      {%- render 'icon', icon: 'note', size: 'lg', class: 'icon-light flex-auto' -%}
                      <span class="text-sm leading-tight reversed-link">{{ 'general.cart.note.title' | t }}</span>
                    </button>
                  {%- endif -%}
                  {%- if section.settings.show_shipping_calculator -%}
                    <button type="button" class="flex items-center justify-center gap-2d5 grow" aria-controls="ShippingCalculator-{{ section.id }}" aria-expanded="false"> 
                      {%- render 'icon', icon: 'package', size: 'lg', class: 'icon-light flex-auto' -%}
                      <span class="text-sm leading-tight reversed-link">{{ 'general.cart.shipping_calculator.title' | t }}</span>
                    </button>
                  {%- endif -%}

                  {%- if section.settings.show_cart_note -%}
                    <modal-element id="CartNote-{{ section.id }}" class="absolute bottom-0 left-0 invisible w-full h-full modal" role="dialog" hidden>
                      <overlay-element class="absolute top-0 left-0 w-full h-full opacity-0 fixed-modal z-1" aria-controls="CartNote-{{ section.id }}" aria-expanded="false"></overlay-element>
                      <div class="absolute bottom-0 left-0 flex flex-col w-full modal__container z-3">
                        <div class="relative flex items-center justify-between modal__header">
                          <span class="text-sm font-medium lg:text-base">{{ 'general.cart.note.caption' | t }}</span>
                          <button class="absolute top-0 right-0 flex items-center justify-center close" type="button" is="magnet-button" aria-controls="CartNote-{{ section.id }}" aria-expanded="false" aria-label="{{ 'general.accessibility.close' | t | escape }}">
                            {%- render 'icon', icon: 'close' -%}
                          </button>
                        </div>
                        <div class="flex flex-col overflow-hidden modal__content">
                          <cart-note class="grid gap-4 modal__scrollable">
                            <div class="field">
                              <textarea name="note" class="textarea is-floating" rows="3" placeholder=" " id="CartNoteForm-{{ section.id }}">{{ cart.note }}</textarea>
                              <label class="label is-floating" for="CartNoteForm-{{ section.id }}">{{ 'general.cart.note.title' | t }}</label>
                            </div>
                            <div class="justify-self-start">
                              <button class="button button--primary" type="button" is="hover-button" aria-controls="CartNote-{{ section.id }}" aria-expanded="false">
                                <span class="btn-fill" data-fill></span>
                                <span class="btn-text">{{ 'general.cart.note.button' | t }}</span>
                              </button>
                            </div>
                          </cart-note>
                        </div>
                      </div>
                    </modal-element>
                  {%- endif -%}
                  {%- if section.settings.show_shipping_calculator -%}
                    <modal-element id="ShippingCalculator-{{ section.id }}" class="absolute bottom-0 left-0 invisible w-full h-full modal" role="dialog" hidden>
                      <overlay-element class="absolute top-0 left-0 w-full h-full opacity-0 fixed-modal z-1" aria-controls="ShippingCalculator-{{ section.id }}" aria-expanded="false"></overlay-element>
                      <div class="absolute bottom-0 left-0 flex flex-col w-full modal__container z-3">
                        <div class="relative flex items-center justify-between modal__header">
                          <span class="text-sm font-medium lg:text-base">{{ 'general.cart.shipping_calculator.caption' | t }}</span>
                          <button class="absolute top-0 right-0 flex items-center justify-center close" type="button" aria-controls="ShippingCalculator-{{ section.id }}" aria-expanded="false" is="magnet-button" aria-label="{{ 'general.accessibility.close' | t | escape }}">
                            {%- render 'icon', icon: 'close' -%}
                          </button>
                        </div>
                        <div class="flex flex-col overflow-hidden modal__content">
                          <form class="grid gap-4 modal__scrollable" action="{{ routes.cart_url }}" method="POST" novalidate is="shipping-calculator">
                            <country-province class="grid gap-4"{% if shop.customer_accounts_enabled and customer %} data-country="{{ customer.default_address.country }}"{% if customer.default_address.province != '' %} data-province="{{ customer.default_address.province }}"{% endif %}{% endif %}>
                              <div class="field">
                                <select
                                  name="address[country]"
                                  class="select is-floating"
                                  autocomplete="country"
                                  is="custom-select"
                                  id="ShippingCalculatorCountry-{{ section.id }}"
                                >
                                  {{- all_country_option_tags -}}
                                </select>
                                {%- render 'icon', icon: 'chevron-up', size: 'sm', class: 'absolute' -%}
                                <label class="label is-floating" for="ShippingCalculatorCountry-{{ section.id }}">{{ 'customer.addresses.country' | t }}</label>
                              </div>
                              <div class="field" hidden>
                                <select
                                  name="address[province]"
                                  class="select is-floating"
                                  autocomplete="address-level1"
                                  is="custom-select"
                                  id="ShippingCalculatorProvince-{{ section.id }}"
                                >
                                </select>
                                {%- render 'icon', icon: 'chevron-up', size: 'sm', class: 'absolute' -%}
                                <label class="label is-floating" for="ShippingCalculatorProvince-{{ section.id }}">{{ 'customer.addresses.province' | t }}</label>
                              </div>
                            </country-province>
                            <div class="field">
                              <input
                                name="address[zip]"
                                class="input is-floating"
                                type="text"
                                autocapitalize="characters"
                                autocomplete="postal-code"
                                placeholder=" "
                                id="ShippingCalculatorZip-{{ section.id }}"
                                {% if shop.customer_accounts_enabled and customer %}value="{{ customer.default_address.zip }}"{% endif %}
                              />
                              <label class="label is-floating" for="ShippingCalculatorZip-{{ section.id }}">{{ 'customer.addresses.zip' | t }}</label>
                            </div>
                            <div class="justify-self-start">
                              <button class="button button--primary" type="submit" is="hover-button">
                                <span class="btn-fill" data-fill></span>
                                <span class="btn-text">{{ 'general.cart.shipping_calculator.button' | t }}</span>
                              </button>
                            </div>
                            <div class="grid gap-3 text-sm"></div>
                          </form>
                        </div>
                      </div>
                    </modal-element>
                  {%- endif -%}
                </div>
              {%- endif -%}
              <div class="jc-flex jc-flex-col jc-gap-4 drawer__footer-bottom jc-px-6 lg:jc-px-12 jc-py-6 jc-pt-4 jc-bg-white jc-border-0 jc-border-t jc-border-solid jc-border-platinum">
                {% assign trust_badges_block = section.blocks | where: "type", "trust_badges" | first %}
                {%- capture trust_badges -%}
                  {%- if trust_badges_block != blank -%}
                    {% for i in (1..3) %}
                      {% assign image_handle = "badge_image_" | append: i %}
                      {% assign image = trust_badges_block.settings[image_handle] %}
                      {%- if image != blank -%}
                        {% render "g-render-image"
                          class: "jc-w-15 jc-h-15 lg:jc-w-17.5 lg:jc-h-17.5",
                          img_src: image.src,
                          img: image,
                          size: "400 800",
                          alt: image.alt,
                          width: image.width,
                          height: image.height,
                          loading: "lazy",
                          id: image.id
                        %}
                      {%- endif -%}
                    {% endfor %}
                  {%- endif -%}
                {%- endcapture -%}

                {%- unless trust_badges == blank -%}
                  <div class="jc-w-fit jc-flex jc-items-center jc-justify-center jc-gap-4 jc-mx-auto jc-mb-4">
                    {{ trust_badges }}
                  </div>
                {%- endunless -%}
                <div class="grid gap-4 sm:grid-6">
                  {%- liquid 
                    assign discount_titles = ""
                    assign current_discount_title = ""
                    assign bundles_savings = 0
          
                    for item in cart.items
                      if item.properties["__foxsell:dynamic_bundle_category"] == blank and item.properties["__foxsell:dynamic_add_on_bundle_id"] == blank
                        if item.final_line_price == 0 or item.original_price > item.final_price or item.variant.compare_at_price > item.variant.price
                          assign discount_item = item.line_level_discount_allocations | first
                          assign discount_item = discount_item.discount_application
                          assign current_discount_title = discount_item.title
                        endif
                      else
                        # calculate bundle savings
                        assign bundle_raw_price = item.properties["_totalRawPrice"]
                        if bundle_raw_price > 0
                          assign cents_price = bundle_raw_price | times: 100
                          assign amount_saved = cents_price | minus: item.original_price
                          assign bundles_savings = bundles_savings | plus: amount_saved
                          assign current_discount_title = "cart.general.bundle_savings_discount_name" | t
                        endif
                      endif
          
                      # Assign discounts' titles
                      if discount_titles contains current_discount_title
                        continue
                      endif
          
                      if discount_titles == blank
                        assign discount_titles = current_discount_title
                      else
                        assign discount_titles = discount_titles | append: " + " | append: current_discount_title
                      endif
                    endfor   
                    
                    # append promocodes titles to discount titles
                    # note: savings amount is calculated by shopify 
                    for item in cart.discount_applications 
                      if discount_titles contains item.title
                        continue
                      endif
          
                      if discount_titles == blank
                        assign discount_titles = item.title
                      else
                        assign discount_titles = discount_titles | append: " + " | append: item.title
                      endif
                    endfor
                  -%}
                  <ul class="jc-flex jc-flex-col jc-gap-y-1.5 [&_p]:jc-text-xs lg:[&_p]:jc-text-sm [&_p]:jc-leading-4 lg:[&_p]:jc-leading-5">
                    <li class="jc-flex">
                      <p>Initial price:</p>
                      <p class="jc-ml-auto">
                        {{ cart.original_total_price | plus: bundles_savings | money }}
                      </p>
                    </li>
                    {% if discount_titles != blank %}
                      <li class="jc-flex">
                        <p>
                          {{ 'cart.general.discount_applied' | t }}:
                          <span class="jc-text-vividTangelo jc-font-bold">{{ discount_titles }}</span>
                        </p>
                        <p class="jc-ml-auto"> 
                          {{ cart.total_discount | plus: bundles_savings | money }}
                        </p>
                      </li>
                    {% endif %}
                    
                    <li class="[&_p]:jc-font-bold jc-flex">
                      <p>Subtotal:</p>
                      <p class="jc-ml-auto">
                        {{ cart.total_price | money }}
                      </p>
                    </li>
                  </ul>
                </div>
  
                {%- if section.settings.show_checkout_button or section.settings.show_view_cart_button -%}
                  <form action="{{ routes.cart_url }}" method="POST" novalidate class="grid grid-cols-12 gap-4 drawer__footer-buttons">
                    {%- if section.settings.show_checkout_button -%}
                      <button class="jc-relative button button--primary icon-with-text{% if section.settings.show_view_cart_button %} col-span-6 lg:col-span-7{% else %} col-span-full{% endif %} jc-rounded-xs jc-px-4 jc-py-4.5" type="submit" name="checkout" is="hover-button">
                        <span class="btn-fill" data-fill></span>
                        <span class="btn-text">
                          {%- liquid
                            render 'icon', icon: 'lock', size: 'sm', class: 'sm:block jc-absolute jc-left-0'
                          -%}
                          <p class="jc-text-base jc-leading-6">{{'cart.general.checkout' | t }}</p>
                        </span>
                      </button>
                    {%- endif -%}
                    
                    {%- if section.settings.show_view_cart_button -%}
                      <a href="{{ routes.cart_url }}" class="button button--secondary{% if section.settings.show_checkout_button %} col-span-6 lg:col-span-5{% else %} col-span-full{% endif %}" is="hover-link" data-no-instant>
                        <span class="btn-fill" data-fill></span>
                        <span class="btn-text">{{ 'general.cart.view_cart' | t }}</span>
                      </a>
                    {%- endif -%}
                  </form>
                {%- endif -%}
                
                <div class="jc-w-full jc-flex jc-justify-center jc-gap-1 jc-flex-nowrap [&_svg]:!jc-w-auto">
                  {% for type in shop.enabled_payment_types %}
                    {{ type | payment_type_svg_tag }}
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </details>

        {%- if section.settings.recent_products_enabled -%}
          <details id="RecentlyViewed-{{ section.id }}" class="flex flex-col h-full overflow-hidden opacity-0 jc-justify-end drawer__panel">
            <summary class="sr-only" tabindex="-1">{{ section.settings.recent_products_heading | escape }}</summary>
            <recently-viewed class="flex flex-col h-full cart__recent" data-url="{{ routes.search_url }}?section_id={{ section.id }}&type=product&q=" data-limit="{{ section.settings.recent_products_limit }}"{% if request.page_type == 'product' %} data-product-id="{{ product.id }}"{% endif %}>
              {%- if request.page_type == 'search' and search.performed and search.results_count > 0 -%}
                {%- liquid
                  assign parsed_terms = search.terms | split: ' OR '
                  capture recent_results
                    for parsed_term in parsed_terms
                      assign product_id = parsed_term | split: 'id:' | last | times: 1
                      for item in search.results
                        if item.id == product_id
                          render 'product-card-horizontal', product: item, show_vendor: section.settings.show_recent_products_vendor, show_price: section.settings.show_recent_products_price, show_quick_add: true, show_quick_view: settings.product_quick_view
                        endif
                      endfor
                    endfor
                  endcapture
                -%}
                {%- if recent_results != blank -%}
                  <div class="relative flex flex-col drawer__scrollable">
                    <div class="grid horizontal-products">
                      {{- recent_results -}}
                    </div>
                  </div>
                {%- endif -%}
              {%- endif -%}
            </recently-viewed>
          </details>
        {%- endif -%}
      </div>
    </div>
  </cart-drawer>
{%- endif -%}

{% schema %}
{
  "name": "t:sections.cart-drawer.name",
  "settings": [
    {
      "type": "paragraph",
      "content": "t:sections.cart-drawer.settings.paragraph.content"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "t:sections.cart-drawer.settings.show_vendor.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "t:sections.cart-drawer.settings.show_cart_note.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_shipping_calculator",
      "label": "t:sections.cart-drawer.settings.show_shipping_calculator.label",
      "info": "t:sections.cart-drawer.settings.show_shipping_calculator.info",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_cart_button",
      "label": "t:sections.cart-drawer.settings.show_view_cart_button.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_checkout_button",
      "label": "t:sections.cart-drawer.settings.show_checkout_button.label",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "step_1_icon",
      "label": "Step 1 icon"
    },
    {
      "type": "image_picker",
      "id": "step_2_icon",
      "label": "Step 2 icon"
    },
    {
      "type": "image_picker",
      "id": "step_3_icon",
      "label": "Step 3 icon"
    },
    {
      "type": "richtext",
      "id": "step_1_text",
      "label": "Step 1 text",
      "default": "<p>Step 1 completed</p>"
      
    },
    {
      "type": "richtext",
      "id": "step_2_text",
      "label": "Step 2 text",
      "default": "<p>Step 2 completed</p>"
    },
    {
      "type": "richtext",
      "id": "step_3_text",
      "label": "Step 3 text",
      "default": "<p>Step 3 completed</p>"
    },
    {
      "type": "header",
      "content": "t:sections.cart-drawer.settings.header__free_shipping.content"
    },
    {
      "type": "checkbox",
      "id": "show_free_shipping_bar",
      "label": "t:sections.cart-drawer.settings.show_free_shipping_bar.label",
      "default": false
    },
    {
      "type": "text",
      "id": "free_shipping_minimum_amount",
      "default": "100",
      "label": "t:sections.cart-drawer.settings.free_shipping_minimum_amount.label",
      "info": "t:sections.cart-drawer.settings.free_shipping_minimum_amount.info"
    },
    {
      "type": "header",
      "content": "t:sections.cart-drawer.settings.header__cart_recommendations.content",
      "info": "t:sections.cart-drawer.settings.header__cart_recommendations.info"
    },
    {
      "type": "checkbox",
      "id": "cart_recommendations_enabled",
      "label": "t:sections.cart-drawer.settings.cart_recommendations_enabled.label",
      "default": true
    },
    {
      "type": "text",
      "id": "cart_recommendations_heading",
      "default": "You may also like",
      "label": "t:sections.cart-drawer.settings.cart_recommendations_heading.label"
    },
    {
      "type": "range",
      "id": "cart_recommendations_limit",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 5,
      "label": "t:sections.cart-drawer.settings.cart_recommendations_limit.label"
    },
    {
      "type": "checkbox",
      "id": "show_cart_recommendations_vendor",
      "label": "t:sections.cart-drawer.settings.show_cart_recommendations_vendor.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_cart_recommendations_price",
      "label": "t:sections.cart-drawer.settings.show_cart_recommendations_price.label",
      "default": true
    },
    {
      "type": "product_list",
      "id": "cart_recommendations_products",
      "label": "t:sections.cart-drawer.settings.cart_recommendations_products.label",
      "info": "t:sections.cart-drawer.settings.cart_recommendations_products.info"
    },
    {
      "type": "header",
      "content": "t:sections.cart-drawer.settings.header__empty_cart.content"
    },
    {
      "type": "richtext",
      "id": "empty_cart_message",
      "label": "t:sections.cart-drawer.settings.empty_cart_message.label"
    },
    {
      "type": "collection_list",
      "id": "empty_cart_collections",
      "label": "t:sections.cart-drawer.settings.empty_cart_collections.label"
    },
    {
      "type": "header",
      "content": "t:sections.cart-drawer.settings.header__recent_products.content"
    },
    {
      "type": "checkbox",
      "id": "recent_products_enabled",
      "label": "t:sections.cart-drawer.settings.recent_products_enabled.label",
      "default": true
    },
    {
      "type": "text",
      "id": "recent_products_heading",
      "default": "Recently viewed",
      "label": "t:sections.cart-drawer.settings.recent_products_heading.label"
    },
    {
      "type": "range",
      "id": "recent_products_limit",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 5,
      "label": "t:sections.cart-drawer.settings.recent_products_limit.label"
    },
    {
      "type": "checkbox",
      "id": "show_recent_products_vendor",
      "label": "t:sections.cart-drawer.settings.show_recent_products_vendor.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_recent_products_price",
      "label": "t:sections.cart-drawer.settings.show_recent_products_price.label",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "trust_badges",
      "name": "Trust badges",
      "settings": [
        {
          "type": "image_picker",
          "id": "badge_image_1",
          "label": "Badge image 1"
        },
        {
          "type": "image_picker",
          "id": "badge_image_2",
          "label": "Badge image 2"
        },
        {
          "type": "image_picker",
          "id": "badge_image_3",
          "label": "Badge image 3"
        }
      ],
      "limit": 1
    }
  ],
  "enabled_on": {
    "groups": [
      "custom.overlay"
    ]
  }
}
{% endschema %}
